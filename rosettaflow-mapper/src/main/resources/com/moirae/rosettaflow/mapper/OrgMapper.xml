<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.moirae.rosettaflow.mapper.OrgMapper">

    <select id="listOrgInfoByNameOrderByTotalDataDesc" resultType="com.moirae.rosettaflow.dto.OrganizationDto">
        select o.identity_id,
               o.node_name,
               o.status,
               o.update_at,
               ifnull(df.total_file,0) as total_file,
               ifnull(df.total_data,0) as total_data
        from dc_org o
        left join (
            select identity_id, count(meta_data_id) as total_file, sum(size) as total_data
            from dc_meta_data
            where status = 2
            group by identity_id
        ) df on o.identity_id = df.identity_id
        where o.status = 1
        <if test="keyword != null and keyword != ''">
            and o.node_name like concat('%', #{keyword, jdbcType=VARCHAR}, '%')
        </if>
        order by df.total_data desc

    </select>
    <select id="listOrgInfoByNameOrderByActivityDesc" resultType="com.moirae.rosettaflow.dto.OrganizationDto">
        select o.identity_id,
               o.node_name,
               o.status,
               o.update_at,
               ifnull(idle.idle_days,0) as idle_days,
               ifnull(task.total_task,0) as task_count
        from dc_org o
        left join (
            select t.identity_id,
                   datediff(current_date(), max(t.create_at)) as idle_days
            from (
                select tpp.identity_id,
                       max(t.create_at) as create_at
                from dc_task_power_provider tpp
                left join dc_task t on tpp.task_id = t.id
                group by tpp.identity_id

                union

                select tmd.identity_id,
                       max(t.create_at) as create_at
                from dc_task_data_provider tmd
                left join dc_task t on tmd.task_id = t.id
                group by tmd.identity_id
        ) t
        group by t.identity_id
        ) idle on o.identity_id = idle.identity_id
        left join (
            select t.identity_id,
                   count(t.task_id) as total_task
            from (
                select tpp.identity_id,
                       tpp.task_id
                from dc_task_power_provider tpp
                join dc_task t on tpp.task_id = t.id
                where datediff(current_date(), t.create_at ) <![CDATA[ <= ]]> 30

                union

                select tmd.identity_id,
                       tmd.task_id
                from dc_task_data_provider tmd
                join dc_task t on tmd.task_id = t.id
                where datediff(current_date(), t.create_at ) <![CDATA[ <= ]]> 30
        ) t
        group by t.identity_id
        ) task on o.identity_id = task.identity_id
        where o.status = 1
        <if test="keyword != null and keyword != ''">
            and o.node_name like concat('%', #{keyword, jdbcType=VARCHAR}, '%')
        </if>
        order by task.total_task desc
    </select>
    <select id="listOrgInfoByNameOrderByMemoryDesc" resultType="com.moirae.rosettaflow.dto.OrganizationDto">
        select o.identity_id,
               o.node_name,
               o.status,
               o.update_at,
               ifnull(power.total_core,0) as total_core,
               ifnull(power.total_memory,0) as total_memory,
               ifnull(power.total_bandwidth,0) as total_bandwidth
        from dc_org o
        left join (
            select identity_id,
                   sum(core) as total_core,
                   sum(memory) as total_memory,
                   sum(bandwidth) as total_bandwidth
            from dc_power_server
            where status = 2 or status = 3
            group by identity_id
        ) power on o.identity_id = power.identity_id
        where o.status = 1
        <if test="keyword != null and keyword != ''">
            and o.node_name like concat('%', #{keyword, jdbcType=VARCHAR}, '%')
        </if>
        order by power.total_memory desc
    </select>
    <select id="findOrgInfoDetail" resultType="com.moirae.rosettaflow.dto.OrganizationDto">
        select o.identity_id,
               o.node_name,
               o.status,
               o.update_at,
               power.total_core,
               power.total_memory,
               power.total_bandwidth,
               data.total_file,
               data.total_data,
               algo.total_algo,
               task.total_task
        from dc_org o,
             (
                 select identity_id,
                        sum(core) as total_core,
                        sum(memory) as total_memory,
                        sum(bandwidth) as total_bandwidth
                 from dc_power_server
                 where identity_id = #{identityId,jdbcType=VARCHAR} and (status = 2 or status = 3)
             ) power,
             (
                 select count(meta_data_id) as total_file,
                        sum(size) as total_data
                 from dc_meta_data
                 where identity_id = #{identityId,jdbcType=VARCHAR} and status = 2
             ) data,
             (
                 select  count(task_id) as total_algo
                 from dc_task_algo_provider
                 where identity_id = #{identityId,jdbcType=VARCHAR}
             ) algo,
             (
                 select count(t.task_id) as total_task
                 from (
                          select task_id
                          from dc_task_power_provider
                          where identity_id = #{identityId,jdbcType=VARCHAR}

                          union

                          select task_id
                          from dc_task_data_provider
                          where identity_id = #{identityId,jdbcType=VARCHAR}
                      ) t
             ) task
        where o.identity_id = #{identityId,jdbcType=VARCHAR}
    </select>
    <select id="getOrgList" resultType="com.moirae.rosettaflow.mapper.domain.Org">
        select o.node_name,
               o.identity_id,
               o.status,
               o.update_at,
               o.image_url,
               so.org_total_core as totalCore,
               so.org_total_memory as totalMemory,
               so.org_total_bandwidth as totalBandwidth,
               so.total_file as totalFile,
               so.total_task as totalTask,
               so.data_token_used as dataTokenUsed
        from dc_org o left join mo_stats_org so on o.identity_id = so.identity_id
        where o.status = 1
        <if test="keyword != null and keyword != ''">
            and ( o.identity_id = #{keyword} or o.node_name like concat('%', #{keyword}, '%') )
        </if>
        order by #{orderBy}
    </select>
    <select id="getOrgDetails" resultType="com.moirae.rosettaflow.mapper.domain.Org">
        select o.node_name,
               o.identity_id,
               o.status,
               o.update_at,
               o.image_url,
               so.org_total_core as totalCore,
               so.org_total_memory as totalMemory,
               so.org_total_bandwidth as totalBandwidth,
               so.total_file as totalFile,
               so.total_task as totalTask,
               so.data_token_used as dataTokenUsed
        from dc_org o left join mo_stats_org so on o.identity_id = so.identity_id
        where o.status = 1 and  o.identity_id = #{identityId}
    </select>
</mapper>
