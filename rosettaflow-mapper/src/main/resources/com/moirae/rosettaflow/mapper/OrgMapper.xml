<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.moirae.rosettaflow.mapper.OrgMapper">
    <resultMap id="BaseResultMap" type="com.moirae.rosettaflow.mapper.domain.Org">
        <id column="identity_id" jdbcType="VARCHAR" property="identityId" />
        <result column="node_name" jdbcType="VARCHAR" property="nodeName" />
        <result column="node_id" jdbcType="VARCHAR" property="nodeId" />
        <result column="image_url" jdbcType="VARCHAR" property="imageUrl" />
        <result column="details" jdbcType="VARCHAR" property="details" />
        <result column="status" jdbcType="INTEGER" property="status" />
        <result column="update_at" jdbcType="TIMESTAMP" property="updateAt" />
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    </resultMap>
    <select id="listOrgInfoByNameOrderByTotalDataDesc" resultType="com.moirae.rosettaflow.dto.OrganizationDto">
        select o.identity_id,
               o.node_name,
               o.status,
               o.update_at,
               ifnull(df.total_file,0) as total_file,
               ifnull(df.total_data,0) as total_data
        from dc_org o
        left join (
            select identity_id, count(meta_data_id) as total_file, sum(size) as total_data
            from dc_meta_data
            where status = 2
            group by identity_id
        ) df on o.identity_id = df.identity_id
        <where>
            <if test="keyword != null and keyword != ''">
                o.node_name like concat('%', #{keyword, jdbcType=VARCHAR}, '%')
            </if>
        </where>
        order by df.total_data desc

    </select>
    <select id="listOrgInfoByNameOrderByActivityDesc" resultType="com.moirae.rosettaflow.dto.OrganizationDto">
        select o.identity_id,
               o.node_name,
               o.status,
               o.update_at,
               ifnull(idle.idle_days,0) as idle_days,
               ifnull(task.total_task,0) as task_count
        from dc_org o
        left join (
            select t.identity_id,
                   datediff(current_date(), max(t.create_at)) as idle_days
            from (
                select tpp.identity_id,
                       max(t.create_at) as create_at
                from dc_task_power_provider tpp
                left join dc_task t on tpp.task_id = t.id
                group by tpp.identity_id

                union

                select tmd.identity_id,
                       max(t.create_at) as create_at
                from dc_task_data_provider tmd
                left join dc_task t on tmd.task_id = t.id
                group by tmd.identity_id
        ) t
        group by t.identity_id
        ) idle on o.identity_id = idle.identity_id
        left join (
            select t.identity_id,
                   count(t.task_id) as total_task
            from (
                select tpp.identity_id,
                       tpp.task_id
                from dc_task_power_provider tpp
                join dc_task t on tpp.task_id = t.id
                where datediff(current_date(), t.create_at ) <![CDATA[ <= ]]> 30

                union

                select tmd.identity_id,
                       tmd.task_id
                from dc_task_data_provider tmd
                join dc_task t on tmd.task_id = t.id
                where datediff(current_date(), t.create_at ) <![CDATA[ <= ]]> 30
        ) t
        group by t.identity_id
        ) task on o.identity_id = task.identity_id
        <where>
            <if test="keyword != null and keyword != ''">
                o.org_name like concat('%', #{keyword, jdbcType=VARCHAR}, '%')
            </if>
        </where>
        order by task.total_task desc
    </select>


</mapper>
